<?php

include('cakhiaconfig.php');

date_default_timezone_set('Asia/Ho_Chi_Minh');

function str_between($str, $start, $end){

    $regex = '#'. $start. '(.*?)'. $end . '#';

    return preg_match($regex, $str, $out) ? $out : [];

}

function get_host(){

    return (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? "https" : "http") . "://$_SERVER[HTTP_HOST]";

}

$playlist_config = '#EXTM3U tvg-shift=0 cache=500 deinterlace=1 aspect-ratio=16:9 m3uautoload=1'. PHP_EOL . PHP_EOL;

$m3u_item_template = '#EXTINF:-1 group-title="%s" tvg-logo="%s",%s'. PHP_EOL .'%s'. PHP_EOL;

$cakhia_play_url_format = get_host()."/playcakhia.php?id=%s&.m3u8";

$ cakhia_item_url_format = "% s | Referer =". $ cakhia_referer;

$ html = file_get_contents ($ cakhia_domain. '/xem-tat-ca.html');

$ js_var = str_between ($ html, "liveShows =", "<\ / script>") [1];

$ js_var = trim (preg_replace ('/ \ s + /', '', $ js_var));

$ jsonstr = preg_replace ("/ ([{,] \ s *) ([a-zA-z _] *?) \ s *: /", '$ 1 "$ 2":', $ js_var);

$ jsonstr = preg_replace ("/'\[(.*?)\]'/", '[$ 1]', $ jsonstr);

$ org_matches = json_decode ($ jsonstr, true);

$ data_by_league = [];

header ("Loại-Nội dung: văn bản / đơn giản");

echo $ playlist_config;

foreach ($ org_matches là $ org_match) {

    $ id = $ org_match ['_ id'];

    $ time = strtotime ($ org_match ['time']);

    $ name = date ("H \ hi d / m:", $ time). 

    (array_key_exists ('teamA', $ org_match)? $ org_match ['teamA'] ['name']: "Không có"). "-".

    (array_key_exists ('teamB', $ org_match)? $ org_match ['teamB'] ['name']: "N / A");

    $ url = sprintf ($ cakhia_item_url_format, sprintf ($ cakhia_play_url_format, $ id));

    if (array_key_exists ($ org_match ['league'], $ cakhia_league_logos)) {

        if (! array_key_exists ($ org_match ['league'], $ data_by_league)) {

            $ data_by_league [$ org_match ['league']] = [];

        }

        array_push ($ data_by_league [$ org_match ['league']], [

            "name" => $ name,

            "url" => $ url

        ]);

        tiếp tục;

    }

    echo sprintf ($ m3u_item_template, $ cakia_group_prefix. "Giải khác", $ cakhia_default_logo, $ name, $ url);

}

foreach ($ data_by_league dưới dạng $ league_name => $ trận đấu) {

    if (sizeof ($ so khớp) <= 0) {

        tiếp tục;

    }

    echo PHP_EOL. PHP_EOL;

    foreach ($ khớp với $ khớp) {

        echo sprintf ($ m3u_item_template, $ cakia_group_prefix. $ league_name, $ cakhia_league_logos [$ league_name], $ match ['name'], $ match ['url']);

    }

}
